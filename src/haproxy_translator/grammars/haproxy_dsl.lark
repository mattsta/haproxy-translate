// HAProxy DSL Grammar for Lark Parser
// Modern configuration language for HAProxy with variables, templates, loops, and Lua support

?start: config

// Top-level configuration
config: "config" identifier "{" statement* "}"

// Statements (order matters for some)
?statement: global_section
          | defaults_section
          | frontend_section
          | backend_section
          | listen_section
          | lua_section
          | acl_definition
          | template_definition
          | variable_declaration
          | import_statement
          | if_statement
          | for_statement

// ===== Global Section =====
global_section: "global" "{" global_property* "}"

?global_property: "daemon" ":" boolean                 -> global_daemon
                | "maxconn" ":" number                 -> global_maxconn
                | "nbthread" ":" number                -> global_nbthread
                | "maxsslconn" ":" number              -> global_maxsslconn
                | "ulimit-n" ":" number                -> global_ulimit_n
                | "user" ":" string                    -> global_user
                | "group" ":" string                   -> global_group
                | "chroot" ":" string                  -> global_chroot
                | "pidfile" ":" string                 -> global_pidfile
                | log_target                           -> global_log
                | lua_section                          -> global_lua
                | stats_section                        -> global_stats
                | "ssl-default-bind-ciphers" ":" string       -> global_ssl_default_bind_ciphers
                | "ssl-default-bind-options" ":" string_array -> global_ssl_default_bind_options

log_target: "log" string log_facility log_level

log_facility: "local0" | "local1" | "local2" | "local3" | "local4" | "local5" | "local6" | "local7" | "user" | "daemon"

log_level: "emerg" | "alert" | "crit" | "err" | "warning" | "notice" | "info" | "debug"

stats_section: "stats" "{" stats_property* "}"

?stats_property: "enable" ":" boolean -> stats_enable
               | "uri" ":" string     -> stats_uri
               | "auth" ":" string    -> stats_auth

// Lua subsection
lua_section: "lua" "{" lua_item* "}"

?lua_item: lua_load
         | lua_script

lua_load: "load" string

lua_script: ("script" | "inline") identifier "{" LUA_CODE "}"
          | ("script" | "inline") identifier "(" lua_param_list ")" "{" LUA_CODE "}"

lua_param_list: lua_param ("," lua_param)*
lua_param: identifier ":" template_var

template_var: TEMPLATE_VAR

LUA_CODE: /([^}]|\}(?!\s*\n))+/  // Match everything until closing brace

TEMPLATE_VAR: /\$\{[a-zA-Z_][a-zA-Z0-9_]*\}/

// ===== Defaults Section =====
defaults_section: "defaults" "{" defaults_property* "}"

?defaults_property: "mode" ":" mode_value              -> defaults_mode
                  | "retries" ":" number               -> defaults_retries
                  | "log" ":" string                   -> defaults_log
                  | "option" ":" string_or_array       -> defaults_option
                  | timeout_block                      -> defaults_timeout
                  | "errorloc" number string           -> defaults_errorloc
                  | "errorloc302" number string        -> defaults_errorloc302
                  | "errorloc303" number string        -> defaults_errorloc303

timeout_block: "timeout" ":" "{" timeout_item+ "}"

timeout_item: identifier ":" duration

duration: number TIME_UNIT

MODE_HTTP: "http"
MODE_TCP: "tcp"

mode_value: MODE_HTTP | MODE_TCP

// ===== Frontend Section =====
frontend_section: "frontend" identifier "{" frontend_property* "}"

?frontend_property: bind_directive
                  | "mode" ":" mode_value                  -> frontend_mode
                  | acl_block
                  | acl_definition
                  | use_acl_directive
                  | http_request_block
                  | http_response_block
                  | tcp_request_block
                  | tcp_response_block
                  | stick_table_block
                  | stick_rule
                  | routing_block
                  | use_backend_rule
                  | "default_backend" ":" identifier       -> frontend_default_backend
                  | "option" ":" string_or_array           -> frontend_option
                  | "timeout_client" ":" duration          -> frontend_timeout_client
                  | "timeout_http_request" ":" duration    -> frontend_timeout_http_request
                  | "timeout_http_keep_alive" ":" duration -> frontend_timeout_http_keep_alive
                  | "monitor_uri" ":" string               -> frontend_monitor_uri
                  | "maxconn" ":" number                   -> frontend_maxconn

bind_directive: "bind" bind_address bind_option*

bind_address: BARE_INTERPOLATION | HOST_PORT | string

// Bare interpolation pattern (matches patterns with ${var} references)
// Matches: ${var}, ${var}:${port}, host:${port}, ${var}:8080, etc.
BARE_INTERPOLATION.3: /(?:[a-zA-Z0-9.*:-]*\$\{[^}]+\})+[a-zA-Z0-9.*:-]*/

HOST_PORT: /[a-zA-Z0-9.*:-]+/

?bind_option: ssl_block
            | BIND_OPTION_NAME value  -> bind_generic_option

BIND_OPTION_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

ssl_block: "ssl" "{" ssl_property* "}"

?ssl_property: "cert" ":" string                 -> ssl_cert
             | "alpn" ":" string_array           -> ssl_alpn
             | SSL_PROPERTY_NAME ":" value       -> ssl_generic

SSL_PROPERTY_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

use_acl_directive: "use" "acl" ":" identifier_array

http_request_block: "http-request" "{" http_rule* "}"
http_response_block: "http-response" "{" http_rule* "}"

http_rule: action_expr if_condition?

action_expr: action_name http_rule_params*

// ===== TCP Request/Response Rules =====
tcp_request_block: "tcp-request" "{" tcp_request_rule* "}"
tcp_response_block: "tcp-response" "{" tcp_response_rule* "}"

// Use priority 5 for TCP keywords to prevent matching as identifiers
TCP_REQUEST_CONNECTION.5: "connection"
TCP_REQUEST_CONTENT.5: "content"
TCP_REQUEST_INSPECT_DELAY.5: "inspect-delay"

tcp_request_rule: tcp_request_type action_name tcp_action_param+ if_condition
                | tcp_request_type action_name tcp_action_param+
                | tcp_request_type action_name if_condition
                | tcp_request_type action_name

tcp_request_type: TCP_REQUEST_CONNECTION | TCP_REQUEST_CONTENT | TCP_REQUEST_INSPECT_DELAY

tcp_response_rule: tcp_response_type action_name tcp_action_param+ if_condition
                 | tcp_response_type action_name tcp_action_param+
                 | tcp_response_type action_name if_condition
                 | tcp_response_type action_name

tcp_response_type: TCP_REQUEST_CONTENT | TCP_REQUEST_INSPECT_DELAY

// TCP action param should not match TCP keywords or "if" - use a restricted identifier
TCP_ACTION_KEYWORD.10: /(?!connection\b|content\b|inspect-delay\b|if\b)[a-zA-Z_][a-zA-Z0-9_]*/

tcp_action_param.10: duration | TCP_ACTION_KEYWORD | number

// ===== Stick Table and Rules =====
stick_table_block: "stick-table" "{" stick_table_property* "}"

// Use priority 5 for stick-table type keywords to prevent ambiguity
STICK_TYPE_IP.5: "ip"
STICK_TYPE_IPV6.5: "ipv6"
STICK_TYPE_INTEGER.5: "integer"
STICK_TYPE_STRING.5: "string"
STICK_TYPE_BINARY.5: "binary"

?stick_table_property: "type" ":" stick_table_type     -> stick_table_type_prop
                     | "size" ":" number                -> stick_table_size
                     | "expire" ":" duration            -> stick_table_expire
                     | "nopurge" ":" boolean            -> stick_table_nopurge
                     | "peers" ":" identifier           -> stick_table_peers
                     | "store" ":" string_array         -> stick_table_store

stick_table_type: STICK_TYPE_IP | STICK_TYPE_IPV6 | STICK_TYPE_INTEGER | STICK_TYPE_STRING | STICK_TYPE_BINARY

stick_rule: stick_rule_type pattern if_condition?

stick_rule_type: "stick" "on"              -> stick_on
               | "stick" "match"           -> stick_match
               | "stick" "store-request"   -> stick_store_request
               | "stick" "store-response"  -> stick_store_response

pattern: function_call | string | qualified_identifier | identifier

function_call: identifier "(" function_args? ")"

function_args: function_arg ("," function_arg)*

function_arg: string | FUNCTION_ARG_NAME | identifier

FUNCTION_ARG_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

action_name: qualified_identifier  // Allow "lua.function_name"

qualified_identifier: identifier ("." identifier)*

?http_rule_params: identifier ":" value  -> http_rule_param
                 | string                -> http_rule_value

if_condition: "if" condition_expr

condition_expr: identifier  // ACL name or expression

routing_block: "route" "{" route_rule* "}"

?route_rule: "to" identifier if_condition?     -> route_to
           | "default" ":" identifier          -> route_default

use_backend_rule: "use_backend" "{" use_backend_item* "}"
                | "use_backend" identifier if_condition?  -> single_use_backend

use_backend_item: "backend" ":" identifier if_condition?

// ===== Backend Section =====
backend_section: "backend" identifier "{" backend_property* "}"

?backend_property: "mode" ":" mode_value                    -> backend_mode
                 | "balance" ":" balance_algo               -> backend_balance
                 | "option" ":" string_or_array             -> backend_option
                 | "cookie" ":" string                      -> backend_cookie
                 | acl_definition                           -> backend_acl
                 | health_check_block                       -> backend_health_check
                 | default_server_directive                 -> backend_default_server
                 | servers_block                            -> backend_servers
                 | server_template_block                    -> backend_server_template
                 | compression_block                        -> backend_compression
                 | http_request_block                       -> backend_http_request
                 | http_response_block                      -> backend_http_response
                 | tcp_request_block                        -> backend_tcp_request
                 | tcp_response_block                       -> backend_tcp_response
                 | stick_table_block                        -> backend_stick_table
                 | stick_rule                               -> backend_stick_rule
                 | "timeout_server" ":" duration            -> backend_timeout_server
                 | "timeout_connect" ":" duration           -> backend_timeout_connect
                 | "timeout_check" ":" duration             -> backend_timeout_check
                 | "retries" ":" number                     -> backend_retries

balance_algo: BALANCE_ROUNDROBIN | BALANCE_LEASTCONN | BALANCE_SOURCE | BALANCE_URI | BALANCE_URL_PARAM | BALANCE_RANDOM | BALANCE_STATIC_RR | BALANCE_FIRST | BALANCE_HDR | BALANCE_RDP_COOKIE

BALANCE_ROUNDROBIN: "roundrobin"
BALANCE_LEASTCONN: "leastconn"
BALANCE_SOURCE: "source"
BALANCE_URI: "uri"
BALANCE_URL_PARAM: "url_param"
BALANCE_RANDOM: "random"
BALANCE_STATIC_RR: "static-rr"
BALANCE_FIRST: "first"
BALANCE_HDR: "hdr"
BALANCE_RDP_COOKIE: "rdp-cookie"

health_check_block: "health-check" "{" health_check_property* "}"

?health_check_property: "method" ":" string         -> hc_method
                      | "uri" ":" string            -> hc_uri
                      | "expect" ":" expect_value   -> hc_expect
                      | header_definition           -> hc_header

expect_value: "status" number

header_definition: "header" string string

default_server_directive: "default-server" "{" default_server_property* "}"

?default_server_property: "check" ":" boolean               -> ds_check
                        | "inter" ":" duration              -> ds_inter
                        | "rise" ":" number                 -> ds_rise
                        | "fall" ":" number                 -> ds_fall
                        | "weight" ":" number               -> ds_weight
                        | "maxconn" ":" number              -> ds_maxconn
                        | "ssl" ":" boolean                 -> ds_ssl
                        | "verify" ":" string               -> ds_verify
                        | "sni" ":" string                  -> ds_sni
                        | "alpn" ":" string_array           -> ds_alpn
                        | "send-proxy" ":" boolean          -> ds_send_proxy
                        | "send-proxy-v2" ":" boolean       -> ds_send_proxy_v2
                        | "slowstart" ":" duration          -> ds_slowstart

servers_block: "servers" "{" server_item* "}"

?server_item: server_definition
            | for_statement

server_definition: "server" (identifier | string) "{" server_property* "}"
                 | "server" identifier server_inline_param+  -> server_inline

server_inline_param: identifier ":" value

?server_property: "address" ":" string              -> server_address
                | "port" ":" number_or_string       -> server_port
                | "check" ":" boolean               -> server_check
                | "inter" ":" duration              -> server_inter
                | "rise" ":" number                 -> server_rise
                | "fall" ":" number                 -> server_fall
                | "weight" ":" number               -> server_weight
                | "maxconn" ":" number              -> server_maxconn
                | "ssl" ":" boolean                 -> server_ssl
                | "verify" ":" string               -> server_verify
                | "sni" ":" string                  -> server_sni
                | "alpn" ":" string_array           -> server_alpn
                | "backup" ":" boolean              -> server_backup
                | "send-proxy" ":" boolean          -> server_send_proxy
                | "send-proxy-v2" ":" boolean       -> server_send_proxy_v2
                | "slowstart" ":" duration          -> server_slowstart
                | template_spread                   -> server_template_spread

template_spread: "@" identifier

server_template_block: "server-template" identifier range_expr "{" server_property* "}"

range_expr: "[" number ".." number "]"

compression_block: "compression" "{" compression_property* "}"

?compression_property: "algo" ":" string              -> compression_algo
                     | "type" ":" string_array        -> compression_type

// ===== Listen Section =====
listen_section: "listen" identifier "{" listen_property* "}"

?listen_property: bind_directive
                | "mode" ":" mode_value                    -> listen_mode
                | "balance" ":" balance_algo               -> listen_balance
                | acl_definition
                | acl_block
                | "option" ":" string_or_array             -> listen_option
                | servers_block                            -> listen_servers
                | health_check_block                       -> listen_health_check
                | "timeout_client" ":" duration            -> listen_timeout_client
                | "timeout_server" ":" duration            -> listen_timeout_server
                | "timeout_connect" ":" duration           -> listen_timeout_connect
                | "maxconn" ":" number                     -> listen_maxconn

// ===== ACL Definition =====
// ACL block containing multiple ACLs
acl_block: "acl" "{" acl_item+ "}"

acl_item: identifier identifier (string | number)*

// Single ACL definition
acl_definition: "acl" identifier "{" acl_criterion "}"

acl_criterion: identifier (string | number)*

// ===== Template Definition =====
template_definition: "template" identifier "{" template_property+ "}"

template_property: identifier ":" value

// ===== Variable Declaration =====
variable_declaration: "let" identifier "=" expression

// ===== Import =====
import_statement: "import" string

// ===== Control Flow =====
if_statement: "if" expression "{" statement* "}" else_clause?

else_clause: "else" "{" statement* "}"
           | "else" if_statement

for_statement: "for" identifier "in" for_iterable "{" for_body "}"

for_iterable: range_expr
            | identifier
            | array

for_body: server_item*

// ===== Expressions =====
?expression: or_expr

?or_expr: and_expr ("||" and_expr)*

?and_expr: comparison_expr ("&&" comparison_expr)*

?comparison_expr: add_expr (comparison_op add_expr)*

comparison_op: "==" | "!=" | "<" | ">" | "<=" | ">="

?add_expr: mul_expr (add_op mul_expr)*

add_op: "+" | "-"

?mul_expr: unary_expr (mul_op unary_expr)*

mul_op: "*" | "/" | "%"

?unary_expr: unary_op unary_expr
           | postfix_expr

unary_op: "!" | "-"

?postfix_expr: primary_expr (postfix_op)*

?postfix_op: "." identifier
           | "[" expression "]"

?primary_expr: identifier
             | number
             | string
             | boolean
             | "(" expression ")"
             | env_call

env_call: "env" "(" string ("," simple_value)? ")"

// ===== Values =====
?value: simple_value
      | array
      | object

?simple_value: string
             | duration  // Must come before number to match duration first
             | number
             | boolean
             | identifier

?string_or_array: string
                | string_array

string_array: "[" [string_list] "]"
string_list: string ("," string)*

identifier_array: "[" [identifier_list] "]"
identifier_list: identifier ("," identifier)*

array: "[" [value_list] "]"
value_list: value ("," value)*

object: "{" [object_pair_list] "}"
object_pair_list: object_pair ("," object_pair)*
object_pair: (identifier | string) ":" value

// ===== Primitives =====
// Terminals defined with priority hints
// Use word boundaries to prevent matching TIME_UNIT as part of identifiers
TIME_UNIT.2: /(?:ms|[smhd])\b/
BOOLEAN.2: "true" | "false" | "yes" | "no" | "on" | "off" | "1" | "0"
INT: /\d+/
FLOAT: /\d+\.\d+/
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/

identifier: IDENTIFIER

string: ESCAPED_STRING | INTERPOLATED_STRING | VAR_REF

INTERPOLATED_STRING: /"[^"]*\$\{[^}]+\}[^"]*"/  // String with ${var}

VAR_REF: /\$\{[a-zA-Z_][a-zA-Z0-9_]*\}/  // Bare ${var} reference

number: INT | FLOAT

?number_or_string: number | string

boolean: BOOLEAN

// ===== Comments and Whitespace =====
%import common.ESCAPED_STRING
%import common.WS
%import common.CPP_COMMENT    // C++ style comments //
%import common.C_COMMENT      // C style comments /* */

%ignore WS
%ignore CPP_COMMENT
%ignore C_COMMENT
