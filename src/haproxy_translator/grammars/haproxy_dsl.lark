// HAProxy DSL Grammar for Lark Parser
// Modern configuration language for HAProxy with variables, templates, loops, and Lua support

?start: config

// Top-level configuration
config: "config" identifier "{" statement* "}"

// Statements (order matters for some)
?statement: global_section
          | defaults_section
          | frontend_section
          | backend_section
          | listen_section
          | peers_section
          | resolvers_section
          | mailers_section
          | lua_section
          | acl_definition
          | template_definition
          | variable_declaration
          | import_statement
          | if_statement
          | for_statement

// ===== Global Section =====
global_section: "global" "{" global_property* "}"

?global_property: "daemon" ":" boolean                 -> global_daemon
                | "maxconn" ":" number                 -> global_maxconn
                | "nbthread" ":" number                -> global_nbthread
                | "nbproc" ":" number                  -> global_nbproc
                | "maxsslconn" ":" number              -> global_maxsslconn
                | "maxconnrate" ":" number             -> global_maxconnrate
                | "maxsslrate" ":" number              -> global_maxsslrate
                | "maxsessrate" ":" number             -> global_maxsessrate
                | "maxpipes" ":" number                -> global_maxpipes
                | "ulimit-n" ":" number                -> global_ulimit_n
                | "user" ":" string                    -> global_user
                | "group" ":" string                   -> global_group
                | "chroot" ":" string                  -> global_chroot
                | "pidfile" ":" string                 -> global_pidfile
                | "ca-base" ":" string                 -> global_ca_base
                | "crt-base" ":" string                -> global_crt_base
                | "key-base" ":" string                -> global_key_base
                | "log-tag" ":" string                 -> global_log_tag
                | "log-send-hostname" ":" string       -> global_log_send_hostname
                | "ssl-dh-param-file" ":" string       -> global_ssl_dh_param_file
                | "ssl-default-bind-ciphers" ":" string       -> global_ssl_default_bind_ciphers
                | "ssl-default-bind-options" ":" string_array -> global_ssl_default_bind_options
                | "ssl-default-bind-ciphersuites" ":" string  -> global_ssl_default_bind_ciphersuites
                | "ssl-default-server-ciphers" ":" string     -> global_ssl_default_server_ciphers
                | "ssl-default-server-ciphersuites" ":" string -> global_ssl_default_server_ciphersuites
                | "ssl-default-server-options" ":" string_array -> global_ssl_default_server_options
                | "ssl-server-verify" ":" string       -> global_ssl_server_verify
                | "ssl-engine" ":" string              -> global_ssl_engine
                | "master-worker" ":" boolean          -> global_master_worker
                | "mworker-max-reloads" ":" number     -> global_mworker_max_reloads
                | "tune.bufsize" ":" number            -> global_tune_bufsize
                | "tune.maxrewrite" ":" number         -> global_tune_maxrewrite
                | "tune.ssl.bufsize" ":" number        -> global_tune_ssl_bufsize
                | "tune.ssl.cachesize" ":" number      -> global_tune_ssl_cachesize
                | "tune.ssl.lifetime" ":" string       -> global_tune_ssl_lifetime
                | "tune.ssl.maxrecord" ":" number      -> global_tune_ssl_maxrecord
                | "tune.ssl.keylog" ":" string         -> global_tune_ssl_keylog
                | "tune.ssl.capture-cipherlist-size" ":" number -> global_tune_ssl_capture_cipherlist_size
                | "tune.ssl.capture-buffer-size" ":" number    -> global_tune_ssl_capture_buffer_size
                | "tune.ssl.default-dh-param" ":" number       -> global_tune_ssl_default_dh_param
                | "tune.ssl.ocsp-update.minthour" ":" number   -> global_tune_ssl_ocsp_update_minthour
                | "tune.ssl.ocsp-update.maxhour" ":" number    -> global_tune_ssl_ocsp_update_maxhour
                | "tune.h2.be.glitches-threshold" ":" number         -> global_tune_h2_be_glitches_threshold
                | "tune.h2.be.initial-window-size" ":" number        -> global_tune_h2_be_initial_window_size
                | "tune.h2.be.max-concurrent-streams" ":" number     -> global_tune_h2_be_max_concurrent_streams
                | "tune.h2.fe.glitches-threshold" ":" number         -> global_tune_h2_fe_glitches_threshold
                | "tune.h2.fe.initial-window-size" ":" number        -> global_tune_h2_fe_initial_window_size
                | "tune.h2.fe.max-concurrent-streams" ":" number     -> global_tune_h2_fe_max_concurrent_streams
                | "tune.h2.fe.max-total-streams" ":" number          -> global_tune_h2_fe_max_total_streams
                | "tune.h2.header-table-size" ":" number             -> global_tune_h2_header_table_size
                | "tune.h2.initial-window-size" ":" number           -> global_tune_h2_initial_window_size
                | "tune.h2.max-concurrent-streams" ":" number        -> global_tune_h2_max_concurrent_streams
                | "tune.h2.max-frame-size" ":" number                -> global_tune_h2_max_frame_size
                | "tune.http.maxhdr" ":" number        -> global_tune_http_maxhdr
                | "tune.http.cookielen" ":" number     -> global_tune_http_cookielen
                | "tune.http.logurilen" ":" number     -> global_tune_http_logurilen
                | "tune.memory.pool-allocator" ":" string   -> global_tune_memory_pool_allocator
                | "tune.memory.fail-alloc" ":" string       -> global_tune_memory_fail_alloc
                | "tune.buffers.limit" ":" number           -> global_tune_buffers_limit
                | "tune.buffers.reserve" ":" number         -> global_tune_buffers_reserve
                | "tune.fd.edge-triggered" ":" boolean      -> global_tune_fd_edge_triggered
                | "tune.comp.maxlevel" ":" number           -> global_tune_comp_maxlevel
                | "uid" ":" number                          -> global_uid
                | "gid" ":" number                          -> global_gid
                | "setcap" ":" string                       -> global_setcap
                | "set-dumpable" ":" boolean                -> global_set_dumpable
                | "unix-bind" ":" string                    -> global_unix_bind
                | "cpu-map" string string                   -> global_cpu_map
                | "hard-stop-after" ":" string              -> global_hard_stop_after
                | "node" ":" string                         -> global_node
                | "description" ":" string                  -> global_description
                | "external-check" ":" boolean              -> global_external_check
                // Phase 4A - Performance & Runtime (9 directives)
                | "busy-polling" ":" boolean              -> global_busy_polling
                | "max-spread-checks" ":" number          -> global_max_spread_checks
                | "spread-checks" ":" number              -> global_spread_checks
                | "maxcompcpuusage" ":" number            -> global_maxcompcpuusage
                | "maxcomprate" ":" number                -> global_maxcomprate
                | "tune.idle-pool.shared" ":" string      -> global_tune_idle_pool_shared
                | "tune.pattern.cache-size" ":" number    -> global_tune_pattern_cache_size
                | "tune.stick-counters" ":" number        -> global_tune_stick_counters
                | "default-path" ":" string               -> global_default_path
                // Phase 4A - Lua Configuration (6 directives)
                | "tune.lua.forced-yield" ":" number      -> global_tune_lua_forced_yield
                | "tune.lua.maxmem" ":" number            -> global_tune_lua_maxmem
                | "tune.lua.session-timeout" ":" string   -> global_tune_lua_session_timeout
                | "tune.lua.task-timeout" ":" string      -> global_tune_lua_task_timeout
                | "tune.lua.service-timeout" ":" string   -> global_tune_lua_service_timeout
                | "tune.lua.log.loggers" ":" string       -> global_tune_lua_log_loggers
                // Phase 4A - Variables Configuration (5 directives)
                | "tune.vars.global-max-size" ":" number  -> global_tune_vars_global_max_size
                | "tune.vars.proc-max-size" ":" number    -> global_tune_vars_proc_max_size
                | "tune.vars.reqres-max-size" ":" number  -> global_tune_vars_reqres_max_size
                | "tune.vars.sess-max-size" ":" number    -> global_tune_vars_sess_max_size
                | "tune.vars.txn-max-size" ":" number     -> global_tune_vars_txn_max_size
                // Phase 4A - Connection Pool (2 directives)
                | "tune.pool.high-fd-ratio" ":" number    -> global_tune_pool_high_fd_ratio
                | "tune.pool.low-fd-ratio" ":" number     -> global_tune_pool_low_fd_ratio
                // Phase 4A - Socket Buffers (4 directives)
                | "tune.rcvbuf.client" ":" number         -> global_tune_rcvbuf_client
                | "tune.rcvbuf.server" ":" number         -> global_tune_rcvbuf_server
                | "tune.sndbuf.client" ":" number         -> global_tune_sndbuf_client
                | "tune.sndbuf.server" ":" number         -> global_tune_sndbuf_server
                // Phase 6 - Performance Tuning (14 directives)
                | "tune.rcvbuf.frontend" ":" number       -> global_tune_rcvbuf_frontend
                | "tune.rcvbuf.backend" ":" number        -> global_tune_rcvbuf_backend
                | "tune.sndbuf.frontend" ":" number       -> global_tune_sndbuf_frontend
                | "tune.sndbuf.backend" ":" number        -> global_tune_sndbuf_backend
                | "tune.maxaccept" ":" number             -> global_tune_maxaccept
                | "tune.maxpollevents" ":" number         -> global_tune_maxpollevents
                | "tune.bufsize.small" ":" number         -> global_tune_bufsize_small
                | "tune.pipesize" ":" number              -> global_tune_pipesize
                | "tune.recv_enough" ":" number           -> global_tune_recv_enough
                | "tune.idletimer" ":" string             -> global_tune_idletimer
                | "tune.runqueue-depth" ":" number        -> global_tune_runqueue_depth
                | "tune.sched.low-latency" ":" boolean    -> global_tune_sched_low_latency
                | "tune.max-checks-per-thread" ":" number -> global_tune_max_checks_per_thread
                | "tune.max-rules-at-once" ":" number     -> global_tune_max_rules_at_once
                // Phase 4B Part 1 - HTTP Client Configuration (6 directives)
                | "httpclient.resolvers.disabled" ":" boolean     -> global_httpclient_resolvers_disabled
                | "httpclient.resolvers.id" ":" string            -> global_httpclient_resolvers_id
                | "httpclient.resolvers.prefer" ":" string        -> global_httpclient_resolvers_prefer
                | "httpclient.retries" ":" number                 -> global_httpclient_retries
                | "httpclient.ssl.verify" ":" string              -> global_httpclient_ssl_verify
                | "httpclient.ssl.ca-file" ":" string             -> global_httpclient_ssl_ca_file
                // Phase 4B Part 1 - Platform-Specific Options (8 directives)
                | "noepoll" ":" boolean                           -> global_noepoll
                | "nokqueue" ":" boolean                          -> global_nokqueue
                | "nopoll" ":" boolean                            -> global_nopoll
                | "nosplice" ":" boolean                          -> global_nosplice
                | "nogetaddrinfo" ":" boolean                     -> global_nogetaddrinfo
                | "noreuseport" ":" boolean                       -> global_noreuseport
                | "limited-quic" ":" boolean                      -> global_limited_quic
                | "localpeer" ":" string                          -> global_localpeer
                // Phase 4B Part 2 - SSL Advanced (7 directives)
                | "ssl-load-extra-files" ":" string              -> global_ssl_load_extra_files
                | "ssl-load-extra-del-ext" ":" string            -> global_ssl_load_extra_del_ext
                | "ssl-mode-async" ":" boolean                   -> global_ssl_mode_async
                | "ssl-propquery" ":" string                     -> global_ssl_propquery
                | "ssl-provider" ":" string                      -> global_ssl_provider
                | "ssl-provider-path" ":" string                 -> global_ssl_provider_path
                | "issuers-chain-path" ":" string                -> global_issuers_chain_path
                // Phase 4B Part 2 - Profiling & Debugging (3 directives)
                | "profiling.tasks.on" ":" boolean               -> global_profiling_tasks_on
                | "profiling.tasks.automatic" ":" boolean        -> global_profiling_tasks_automatic
                | "profiling.memory.on" ":" boolean              -> global_profiling_memory_on
                // Phase 4B Part 3 - QUIC/HTTP3 Support (7 directives)
                | "tune.quic.frontend.conn-tx-buffers.limit" ":" number   -> global_tune_quic_frontend_conn_tx_buffers_limit
                | "tune.quic.frontend.max-idle-timeout" ":" string        -> global_tune_quic_frontend_max_idle_timeout
                | "tune.quic.frontend.max-streams-bidi" ":" number        -> global_tune_quic_frontend_max_streams_bidi
                | "tune.quic.frontend.glitches-threshold" ":" number      -> global_tune_quic_frontend_glitches_threshold
                | "tune.quic.retry-threshold" ":" number                  -> global_tune_quic_retry_threshold
                | "tune.quic.socket.owner" ":" string                     -> global_tune_quic_socket_owner
                | "tune.quic.max-frame-loss" ":" number                   -> global_tune_quic_max_frame_loss
                // Phase 4B Part 4 - Device Detection (15 directives)
                // DeviceAtlas (4 directives)
                | "deviceatlas-json-file" ":" string                      -> global_deviceatlas_json_file
                | "deviceatlas-log-level" ":" number                      -> global_deviceatlas_log_level
                | "deviceatlas-separator" ":" string                      -> global_deviceatlas_separator
                | "deviceatlas-properties-cookie" ":" string              -> global_deviceatlas_properties_cookie
                // 51Degrees (4 directives)
                | "51degrees-data-file" ":" string                        -> global_51degrees_data_file
                | "51degrees-property-name-list" ":" string               -> global_51degrees_property_name_list
                | "51degrees-property-separator" ":" string               -> global_51degrees_property_separator
                | "51degrees-cache-size" ":" number                       -> global_51degrees_cache_size
                // WURFL (7 directives)
                | "wurfl-data-file" ":" string                            -> global_wurfl_data_file
                | "wurfl-information-list" ":" string                     -> global_wurfl_information_list
                | "wurfl-information-list-separator" ":" string           -> global_wurfl_information_list_separator
                | "wurfl-patch-file" ":" string                           -> global_wurfl_patch_file
                | "wurfl-cache-size" ":" number                           -> global_wurfl_cache_size
                | "wurfl-engine-mode" ":" string                          -> global_wurfl_engine_mode
                | "wurfl-useragent-priority" ":" string                   -> global_wurfl_useragent_priority
                // Compression Tuning (Final Phase - 2 directives)
                | "tune.zlib.memlevel" ":" number                         -> global_tune_zlib_memlevel
                | "tune.zlib.windowsize" ":" number                       -> global_tune_zlib_windowsize
                | "setenv" string string               -> global_setenv
                | "presetenv" string string            -> global_presetenv
                | "resetenv" string                    -> global_resetenv
                | "unsetenv" string                    -> global_unsetenv
                | log_target                           -> global_log
                | lua_section                          -> global_lua
                | stats_section                        -> global_stats
                | stats_socket_item                    -> global_stats_socket

log_target: "log" string log_facility log_level

log_facility: "local0" | "local1" | "local2" | "local3" | "local4" | "local5" | "local6" | "local7" | "user" | "daemon"

log_level: "emerg" | "alert" | "crit" | "err" | "warning" | "notice" | "info" | "debug"

stats_section: "stats" "{" stats_property* "}"

?stats_property: "enable" ":" boolean -> stats_enable
               | "uri" ":" string     -> stats_uri
               | "auth" ":" string    -> stats_auth

// Lua subsection
lua_section: "lua" "{" lua_item* "}"

?lua_item: lua_load
         | lua_script

lua_load: "load" string

lua_script: ("script" | "inline") identifier "{" LUA_CODE "}"
          | ("script" | "inline") identifier "(" lua_param_list ")" "{" LUA_CODE "}"

lua_param_list: lua_param ("," lua_param)*
lua_param: identifier ":" template_var

template_var: TEMPLATE_VAR

LUA_CODE: /([^}]|\}(?!\s*\n))+/  // Match everything until closing brace

TEMPLATE_VAR: /\$\{[a-zA-Z_][a-zA-Z0-9_]*\}/

// ===== Defaults Section =====
defaults_section: "defaults" "{" defaults_property* "}"

?defaults_property: "mode" ":" mode_value              -> defaults_mode
                  | "retries" ":" number               -> defaults_retries
                  | "log" ":" string                   -> defaults_log
                  | "error-log-format" ":" string      -> defaults_error_log_format
                  | "option" ":" string_or_array       -> defaults_option
                  | timeout_block                      -> defaults_timeout
                  | "errorloc" number string           -> defaults_errorloc
                  | "errorloc302" number string        -> defaults_errorloc302
                  | "errorloc303" number string        -> defaults_errorloc303
                  | email_alert_block                  -> defaults_email_alert
                  | "clitcpka-cnt" ":" number          -> defaults_clitcpka_cnt
                  | "clitcpka-idle" ":" duration       -> defaults_clitcpka_idle
                  | "clitcpka-intvl" ":" duration      -> defaults_clitcpka_intvl
                  | "srvtcpka-cnt" ":" number          -> defaults_srvtcpka_cnt
                  | "srvtcpka-idle" ":" duration       -> defaults_srvtcpka_idle
                  | "srvtcpka-intvl" ":" duration      -> defaults_srvtcpka_intvl
                  | "rate-limit" "sessions" ":" number -> defaults_rate_limit_sessions

timeout_block: "timeout" ":" "{" timeout_item+ "}"

timeout_item: identifier ":" duration

duration: number TIME_UNIT

MODE_HTTP: "http"
MODE_TCP: "tcp"

mode_value: MODE_HTTP | MODE_TCP

// ===== Frontend Section =====
frontend_section: "frontend" identifier "{" frontend_property* "}"

?frontend_property: bind_directive
                  | "mode" ":" mode_value                  -> frontend_mode
                  | "description" ":" string               -> frontend_description
                  | "disabled" ":" boolean                 -> frontend_disabled
                  | "enabled" ":" boolean                  -> frontend_enabled
                  | "id" ":" number                        -> frontend_id
                  | "guid" ":" string                      -> frontend_guid
                  | "unique-id-format" ":" string         -> frontend_unique_id_format
                  | "unique-id-header" ":" string         -> frontend_unique_id_header
                  | acl_block
                  | acl_definition
                  | use_acl_directive
                  | http_request_block
                  | http_response_block
                  | http_after_response_block
                  | tcp_request_block
                  | tcp_response_block
                  | stick_table_block
                  | stick_rule
                  | routing_block
                  | use_backend_rule
                  | "default_backend" ":" identifier       -> frontend_default_backend
                  | "option" ":" string_or_array           -> frontend_option
                  | "timeout_client" ":" duration          -> frontend_timeout_client
                  | "timeout_http_request" ":" duration    -> frontend_timeout_http_request
                  | "timeout_http_keep_alive" ":" duration -> frontend_timeout_http_keep_alive
                  | "timeout_client_fin" ":" duration      -> frontend_timeout_client_fin
                  | "timeout_tarpit" ":" duration          -> frontend_timeout_tarpit
                  | "monitor_uri" ":" string               -> frontend_monitor_uri
                  | "monitor-net" string                   -> frontend_monitor_net
                  | "monitor" "fail" if_condition          -> frontend_monitor_fail
                  | "maxconn" ":" number                   -> frontend_maxconn
                  | "backlog" ":" number                   -> frontend_backlog
                  | "fullconn" ":" number                  -> frontend_fullconn
                  | "max-keep-alive-queue" ":" number     -> frontend_max_keep_alive_queue
                  | "log" ":" string                       -> frontend_log
                  | "log-tag" ":" string                   -> frontend_log_tag
                  | "log-format" ":" string                -> frontend_log_format
                  | "error-log-format" ":" string          -> frontend_error_log_format
                  | "log-format-sd" ":" string             -> frontend_log_format_sd
                  | stats_block                            -> frontend_stats
                  | "capture" "request" "header" string number  -> frontend_capture_request_header
                  | "capture" "response" "header" string number -> frontend_capture_response_header
                  | redirect_rule                          -> frontend_redirect
                  | errorfile_directive                    -> frontend_errorfile
                  | errorloc_directive                     -> frontend_errorloc
                  | http_error_block                       -> frontend_http_error
                  | email_alert_block                      -> frontend_email_alert
                  | declare_capture_directive              -> frontend_declare_capture
                  | force_persist_directive                -> frontend_force_persist
                  | ignore_persist_directive               -> frontend_ignore_persist
                  | "clitcpka-cnt" ":" number              -> frontend_clitcpka_cnt
                  | "clitcpka-idle" ":" duration           -> frontend_clitcpka_idle
                  | "clitcpka-intvl" ":" duration          -> frontend_clitcpka_intvl
                  | "rate-limit" "sessions" ":" number     -> frontend_rate_limit_sessions

// Redirect rules
redirect_rule: "redirect" redirect_type string redirect_options?

?redirect_type: "location"     -> redirect_location
              | "prefix"       -> redirect_prefix
              | "scheme"       -> redirect_scheme

?redirect_options: redirect_option+

?redirect_option: "code" number          -> redirect_code
                | "drop-query"           -> redirect_drop_query
                | "append-slash"         -> redirect_append_slash
                | "set-cookie" string    -> redirect_set_cookie
                | "clear-cookie" string  -> redirect_clear_cookie
                | "if" identifier        -> redirect_if
                | "unless" identifier    -> redirect_unless

// Error file directive
errorfile_directive: "errorfile" number string

// Error location redirect directives
errorloc_directive: "errorloc" number string      -> errorloc
                  | "errorloc302" number string    -> errorloc302
                  | "errorloc303" number string    -> errorloc303

// HTTP error response directive
http_error_block: "http-error" "{" http_error_property+ "}"

?http_error_property: "status" ":" number                    -> http_error_status
                    | "content-type" ":" string              -> http_error_content_type
                    | "file" ":" string                      -> http_error_file
                    | "lf-file" ":" string                   -> http_error_lf_file
                    | "string" ":" string                    -> http_error_string
                    | "lf-string" ":" string                 -> http_error_lf_string
                    | "errorfile" ":" string                 -> http_error_errorfile
                    | "errorfiles-name" ":" string           -> http_error_errorfiles_name
                    | "default-errorfiles" ":" boolean       -> http_error_default_errorfiles

// Email alert configuration
email_alert_block: "email-alert" "{" email_alert_property+ "}"

?email_alert_property: "level" ":" identifier                -> email_alert_level
                     | "mailers" ":" identifier               -> email_alert_mailers
                     | "from" ":" string                      -> email_alert_from
                     | "to" ":" string                        -> email_alert_to
                     | "myhostname" ":" string                -> email_alert_myhostname

// Declare capture directive
declare_capture_directive: "declare" "capture" capture_type "len" number

?capture_type: CAPTURE_REQUEST | CAPTURE_RESPONSE

CAPTURE_REQUEST: "request"
CAPTURE_RESPONSE: "response"

// Force persist and ignore persist directives
force_persist_directive: "force-persist" if_condition

ignore_persist_directive: "ignore-persist" if_condition

// Stats block (proxy-level)
stats_block: "stats" "{" proxy_stats_property* "}"

?proxy_stats_property: "enable" ":" boolean                  -> stats_enable
                     | "uri" ":" string                      -> stats_uri
                     | "realm" ":" string                    -> stats_realm
                     | "auth" ":" string                     -> stats_auth
                     | "hide-version" ":" boolean            -> stats_hide_version
                     | "refresh" ":" (number | duration)     -> stats_refresh
                     | "show-legends" ":" boolean            -> stats_show_legends
                     | "show-desc" ":" string                -> stats_show_desc
                     | "admin" if_condition                  -> stats_admin

bind_directive: "bind" bind_address bind_option*

bind_address: BARE_INTERPOLATION | HOST_PORT | string

// Bare interpolation pattern (matches patterns with ${var} references)
// Matches: ${var}, ${var}:${port}, host:${port}, ${var}:8080, etc.
BARE_INTERPOLATION.3: /(?:[a-zA-Z0-9.*:-]*\$\{[^}]+\})+[a-zA-Z0-9.*:-]*/

HOST_PORT: /[a-zA-Z0-9.*:-]+/

?bind_option: ssl_block
            | BIND_OPTION_NAME value    -> bind_generic_option

BIND_OPTION_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

ssl_block: "ssl" "{" ssl_property* "}"

?ssl_property: "cert" ":" string                 -> ssl_cert
             | "alpn" ":" string_array           -> ssl_alpn
             | SSL_PROPERTY_NAME ":" value       -> ssl_generic

SSL_PROPERTY_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

use_acl_directive: "use" "acl" ":" identifier_array

http_request_block: "http-request" "{" http_request_rule* "}"
http_response_block: "http-response" "{" http_response_rule* "}"
http_after_response_block: "http-after-response" "{" http_after_response_rule* "}"

http_request_rule: action_expr if_condition?
http_response_rule: action_expr if_condition?
http_after_response_rule: action_expr if_condition?

action_expr: action_name http_rule_params*

// ===== TCP Request/Response Rules =====
tcp_request_block: "tcp-request" "{" tcp_request_rule* "}"
tcp_response_block: "tcp-response" "{" tcp_response_rule* "}"

// Use priority 5 for TCP keywords to prevent matching as identifiers
TCP_REQUEST_CONNECTION.5: "connection"
TCP_REQUEST_CONTENT.5: "content"
TCP_REQUEST_INSPECT_DELAY.5: "inspect-delay"

tcp_request_rule: tcp_request_type action_name tcp_action_param+ if_condition
                | tcp_request_type action_name tcp_action_param+
                | tcp_request_type action_name if_condition
                | tcp_request_type action_name

tcp_request_type: TCP_REQUEST_CONNECTION | TCP_REQUEST_CONTENT | TCP_REQUEST_INSPECT_DELAY

tcp_response_rule: tcp_response_type action_name tcp_action_param+ if_condition
                 | tcp_response_type action_name tcp_action_param+
                 | tcp_response_type action_name if_condition
                 | tcp_response_type action_name

tcp_response_type: TCP_REQUEST_CONTENT | TCP_REQUEST_INSPECT_DELAY

// TCP action param should not match TCP keywords or "if" - use a restricted identifier
TCP_ACTION_KEYWORD.10: /(?!connection\b|content\b|inspect-delay\b|if\b)[a-zA-Z_][a-zA-Z0-9_]*/

tcp_action_param.10: duration | TCP_ACTION_KEYWORD | number

// ===== Stick Table and Rules =====
stick_table_block: "stick-table" "{" stick_table_property* "}"

// Use priority 5 for stick-table type keywords to prevent ambiguity
STICK_TYPE_IP.5: "ip"
STICK_TYPE_IPV6.5: "ipv6"
STICK_TYPE_INTEGER.5: "integer"
STICK_TYPE_STRING.5: "string"
STICK_TYPE_BINARY.5: "binary"

?stick_table_property: "type" ":" stick_table_type     -> stick_table_type_prop
                     | "size" ":" number                -> stick_table_size
                     | "expire" ":" duration            -> stick_table_expire
                     | "nopurge" ":" boolean            -> stick_table_nopurge
                     | "peers" ":" identifier           -> stick_table_peers
                     | "store" ":" string_array         -> stick_table_store

stick_table_type: STICK_TYPE_IP | STICK_TYPE_IPV6 | STICK_TYPE_INTEGER | STICK_TYPE_STRING | STICK_TYPE_BINARY

stick_rule: stick_rule_type pattern if_condition?

stick_rule_type: "stick" "on"              -> stick_on
               | "stick" "match"           -> stick_match
               | "stick" "store-request"   -> stick_store_request
               | "stick" "store-response"  -> stick_store_response

pattern: function_call | string | qualified_identifier | identifier

function_call: identifier "(" function_args? ")"

function_args: function_arg ("," function_arg)*

function_arg: string | FUNCTION_ARG_NAME | identifier

FUNCTION_ARG_NAME: /[a-zA-Z_][a-zA-Z0-9_-]*/

action_name: qualified_identifier  // Allow "lua.function_name"

qualified_identifier: identifier ("." identifier)*

?http_rule_params: identifier ":" value  -> http_rule_param
                 | string                -> http_rule_value

if_condition: "if" condition_expr

condition_expr: identifier  // ACL name or expression

routing_block: "route" "{" route_rule* "}"

?route_rule: "to" identifier if_condition?     -> route_to
           | "default" ":" identifier          -> route_default

use_backend_rule: "use_backend" "{" use_backend_item* "}"
                | "use_backend" identifier if_condition?  -> single_use_backend

use_backend_item: "backend" ":" identifier if_condition?

// ===== Backend Section =====
backend_section: "backend" identifier "{" backend_property* "}"

?backend_property: "mode" ":" mode_value                    -> backend_mode
                 | "description" ":" string                 -> backend_description
                 | "disabled" ":" boolean                   -> backend_disabled
                 | "enabled" ":" boolean                    -> backend_enabled
                 | "id" ":" number                          -> backend_id
                 | "guid" ":" string                        -> backend_guid
                 | "balance" ":" balance_algo               -> backend_balance
                 | "option" ":" string_or_array             -> backend_option
                 | "cookie" ":" string                      -> backend_cookie
                 | acl_definition                           -> backend_acl
                 | health_check_block                       -> backend_health_check
                 | default_server_directive                 -> backend_default_server
                 | servers_block                            -> backend_servers
                 | server_template_block                    -> backend_server_template
                 | compression_block                        -> backend_compression
                 | http_request_block                       -> backend_http_request
                 | http_response_block                      -> backend_http_response
                 | http_after_response_block                -> backend_http_after_response
                 | tcp_request_block                        -> backend_tcp_request
                 | tcp_response_block                       -> backend_tcp_response
                 | stick_table_block                        -> backend_stick_table
                 | stick_rule                               -> backend_stick_rule
                 | "timeout_server" ":" duration            -> backend_timeout_server
                 | "timeout_connect" ":" duration           -> backend_timeout_connect
                 | "timeout_check" ":" duration             -> backend_timeout_check
                 | "timeout_tunnel" ":" duration            -> backend_timeout_tunnel
                 | "timeout_server_fin" ":" duration        -> backend_timeout_server_fin
                 | "retries" ":" number                     -> backend_retries
                 | "maxconn" ":" number                     -> backend_maxconn
                 | "backlog" ":" number                     -> backend_backlog
                 | "max-keep-alive-queue" ":" number       -> backend_max_keep_alive_queue
                 | "max-session-srv-conns" ":" number      -> backend_max_session_srv_conns
                 | "log" ":" string                         -> backend_log
                 | "log-tag" ":" string                     -> backend_log_tag
                 | "log-format" ":" string                  -> backend_log_format
                 | "error-log-format" ":" string            -> backend_error_log_format
                 | "log-format-sd" ":" string               -> backend_log_format_sd
                 | redirect_rule                            -> backend_redirect
                 | errorfile_directive                      -> backend_errorfile
                 | errorloc_directive                       -> backend_errorloc
                 | http_error_block                         -> backend_http_error
                 | email_alert_block                        -> backend_email_alert
                 | declare_capture_directive                -> backend_declare_capture
                 | force_persist_directive                  -> backend_force_persist
                 | ignore_persist_directive                 -> backend_ignore_persist
                 | "errorfiles" ":" string                  -> backend_errorfiles
                 | "dispatch" ":" string                    -> backend_dispatch
                 | "use-fcgi-app" ":" string                -> backend_use_fcgi_app
                 | "http-reuse" ":" http_reuse_mode         -> backend_http_reuse
                 | "http-send-name-header" ":" string      -> backend_http_send_name_header
                 | "retry-on" ":" string                   -> backend_retry_on
                 | "source" ":" string                      -> backend_source
                 | "external-check" "command" ":" string   -> backend_external_check_command
                 | "external-check" "path" ":" string      -> backend_external_check_path
                 | use_server_rule                          -> backend_use_server
                 | http_check_block                         -> backend_http_check
                 | tcp_check_block                          -> backend_tcp_check
                 | "hash-type" ":" hash_type_spec           -> backend_hash_type
                 | "hash-balance-factor" ":" number         -> backend_hash_balance_factor
                 | "hash-preserve-affinity" ":" hash_preserve_affinity_mode -> backend_hash_preserve_affinity
                 | "load-server-state-from-file" ":" load_server_state_mode  -> backend_load_server_state_from
                 | "server-state-file-name" ":" server_state_file_name_value  -> backend_server_state_file_name
                 | "srvtcpka-cnt" ":" number               -> backend_srvtcpka_cnt
                 | "srvtcpka-idle" ":" duration            -> backend_srvtcpka_idle
                 | "srvtcpka-intvl" ":" duration           -> backend_srvtcpka_intvl

?server_state_file_name_value: SERVER_STATE_USE_BACKEND_NAME | string

SERVER_STATE_USE_BACKEND_NAME: "use-backend-name"

?http_reuse_mode: HTTP_REUSE_NEVER | HTTP_REUSE_SAFE | HTTP_REUSE_AGGRESSIVE | HTTP_REUSE_ALWAYS

HTTP_REUSE_NEVER: "never"
HTTP_REUSE_SAFE: "safe"
HTTP_REUSE_AGGRESSIVE: "aggressive"
HTTP_REUSE_ALWAYS: "always"

?load_server_state_mode: LOAD_SERVER_STATE_GLOBAL | LOAD_SERVER_STATE_LOCAL | LOAD_SERVER_STATE_NONE

LOAD_SERVER_STATE_GLOBAL: "global"
LOAD_SERVER_STATE_LOCAL: "local"
LOAD_SERVER_STATE_NONE: "none"

?hash_preserve_affinity_mode: HASH_PRESERVE_ALWAYS | HASH_PRESERVE_MAXCONN | HASH_PRESERVE_MAXQUEUE

HASH_PRESERVE_ALWAYS: "always"
HASH_PRESERVE_MAXCONN: "maxconn"
HASH_PRESERVE_MAXQUEUE: "maxqueue"

balance_algo: BALANCE_ROUNDROBIN | BALANCE_LEASTCONN | BALANCE_SOURCE | BALANCE_URI | BALANCE_URL_PARAM | BALANCE_RANDOM | BALANCE_STATIC_RR | BALANCE_FIRST | BALANCE_HDR | BALANCE_RDP_COOKIE

BALANCE_ROUNDROBIN: "roundrobin"
BALANCE_LEASTCONN: "leastconn"
BALANCE_SOURCE: "source"
BALANCE_URI: "uri"
BALANCE_URL_PARAM: "url_param"
BALANCE_RANDOM: "random"
BALANCE_STATIC_RR: "static-rr"
BALANCE_FIRST: "first"
BALANCE_HDR: "hdr"
BALANCE_RDP_COOKIE: "rdp-cookie"

// Hash-type specification
hash_type_spec: hash_method hash_function? hash_modifier?

hash_method: HASH_MAP_BASED | HASH_CONSISTENT
hash_function: HASH_SDBM | HASH_DJB2 | HASH_WT6 | HASH_CRC32
hash_modifier: HASH_MOD_AVALANCHE

HASH_MAP_BASED: "map-based"
HASH_CONSISTENT: "consistent"
HASH_SDBM: "sdbm"
HASH_DJB2: "djb2"
HASH_WT6: "wt6"
HASH_CRC32: "crc32"
HASH_MOD_AVALANCHE: "avalanche"

health_check_block: "health-check" "{" health_check_property* "}"

?health_check_property: "method" ":" string         -> hc_method
                      | "uri" ":" string            -> hc_uri
                      | "expect" ":" expect_value   -> hc_expect
                      | header_definition           -> hc_header

expect_value: "status" number                       -> expect_status
            | "string" string                       -> expect_string
            | "rstatus" string                      -> expect_rstatus
            | "rstring" string                      -> expect_rstring
            | "!" "status" number                   -> expect_not_status
            | "!" "string" string                   -> expect_not_string
            | "!" "rstatus" string                  -> expect_not_rstatus
            | "!" "rstring" string                  -> expect_not_rstring

header_definition: "header" string string

// ===== use-server Directive =====
use_server_rule: "use-server" identifier if_condition?

// ===== http-check Block =====
http_check_block: "http-check" "{" http_check_rule+ "}"

?http_check_rule: "send" http_check_send_options     -> http_check_send
                | "expect" http_check_expect          -> http_check_expect
                | "connect" http_check_connect_options -> http_check_connect
                | "disable-on-404"                    -> http_check_disable_on_404

http_check_send_options: "method" string "uri" string http_check_headers?  -> http_check_send_with_uri
                       | "method" string http_check_headers?              -> http_check_send_method_only

?http_check_headers: "headers" "{" header_definition* "}"

?http_check_expect: expect_value

http_check_connect_options: "port" number http_check_ssl_options?  -> http_check_connect_with_port
                          | http_check_ssl_options                -> http_check_connect_ssl_only

?http_check_ssl_options: "ssl" ("sni" string)? ("alpn" string)?

// ===== tcp-check Block =====
tcp_check_block: "tcp-check" "{" tcp_check_rule+ "}"

?tcp_check_rule: "connect" tcp_check_connect_options  -> tcp_check_connect
               | "send" string                        -> tcp_check_send
               | "send-binary" string                 -> tcp_check_send_binary
               | "expect" tcp_check_expect_options    -> tcp_check_expect
               | "comment" string                     -> tcp_check_comment

tcp_check_connect_options: "port" number tcp_check_ssl_options?  -> tcp_check_connect_with_port
                         | tcp_check_ssl_options                -> tcp_check_connect_ssl_only

?tcp_check_ssl_options: "ssl" ("sni" string)? ("alpn" string)?

?tcp_check_expect_options: "string" string | "binary" string | "rstring" string

default_server_directive: "default-server" "{" default_server_property* "}"

?default_server_property: "check" ":" boolean               -> ds_check
                        | "inter" ":" duration              -> ds_inter
                        | "rise" ":" number                 -> ds_rise
                        | "fall" ":" number                 -> ds_fall
                        | "weight" ":" number               -> ds_weight
                        | "maxconn" ":" number              -> ds_maxconn
                        | "ssl" ":" boolean                 -> ds_ssl
                        | "verify" ":" string               -> ds_verify
                        | "sni" ":" string                  -> ds_sni
                        | "alpn" ":" string_array           -> ds_alpn
                        | "send-proxy" ":" boolean          -> ds_send_proxy
                        | "send-proxy-v2" ":" boolean       -> ds_send_proxy_v2
                        | "slowstart" ":" duration          -> ds_slowstart
                        | "check-ssl" ":" boolean           -> ds_check_ssl
                        | "check-sni" ":" string            -> ds_check_sni
                        | "ssl-min-ver" ":" string          -> ds_ssl_min_ver
                        | "ssl-max-ver" ":" string          -> ds_ssl_max_ver
                        | "ca-file" ":" string              -> ds_ca_file
                        | "crt" ":" string                  -> ds_crt
                        | "source" ":" string               -> ds_source

servers_block: "servers" "{" server_item* "}"

?server_item: server_definition
            | for_statement

server_definition: "server" (identifier | string) "{" server_property* "}"
                 | "server" identifier server_inline_param+  -> server_inline

server_inline_param: identifier ":" value

?server_property: "address" ":" string              -> server_address
                | "port" ":" number_or_string       -> server_port
                | "check" ":" boolean               -> server_check
                | "inter" ":" duration              -> server_inter
                | "rise" ":" number                 -> server_rise
                | "fall" ":" number                 -> server_fall
                | "weight" ":" number               -> server_weight
                | "maxconn" ":" number              -> server_maxconn
                | "minconn" ":" number              -> server_minconn
                | "maxqueue" ":" number             -> server_maxqueue
                | "ssl" ":" boolean                 -> server_ssl
                | "verify" ":" string               -> server_verify
                | "sni" ":" string                  -> server_sni
                | "alpn" ":" string_array           -> server_alpn
                | "backup" ":" boolean              -> server_backup
                | "send-proxy" ":" boolean          -> server_send_proxy
                | "send-proxy-v2" ":" boolean       -> server_send_proxy_v2
                | "slowstart" ":" duration          -> server_slowstart
                | "check-ssl" ":" boolean           -> server_check_ssl
                | "check-sni" ":" string            -> server_check_sni
                | "ssl-min-ver" ":" string          -> server_ssl_min_ver
                | "ssl-max-ver" ":" string          -> server_ssl_max_ver
                | "ca-file" ":" string              -> server_ca_file
                | "crt" ":" string                  -> server_crt
                | "source" ":" string               -> server_source
                | "id" ":" number                   -> server_id
                | "cookie" ":" string               -> server_cookie
                | "disabled" ":" boolean            -> server_disabled
                | "enabled" ":" boolean             -> server_enabled
                | "init-addr" ":" string            -> server_init_addr
                | "max-reuse" ":" number            -> server_max_reuse
                | "pool-max-conn" ":" number        -> server_pool_max_conn
                | "pool-purge-delay" ":" duration   -> server_pool_purge_delay
                | "resolvers" ":" string            -> server_resolvers
                | "resolve-prefer" ":" string       -> server_resolve_prefer
                | "error-limit" ":" number          -> server_error_limit
                | "observe" ":" string              -> server_observe
                | "on-error" ":" string             -> server_on_error
                | "on-marked-down" ":" string       -> server_on_marked_down
                | "on-marked-up" ":" string         -> server_on_marked_up
                | "proto" ":" string                -> server_proto
                | "redir" ":" string                -> server_redir
                | "tfo" ":" boolean                 -> server_tfo
                | "track" ":" string                -> server_track
                | "usesrc" ":" string               -> server_usesrc
                | "namespace" ":" string            -> server_namespace
                | "agent-check" ":" boolean         -> server_agent_check
                | "agent-port" ":" number           -> server_agent_port
                | "agent-addr" ":" string           -> server_agent_addr
                | "agent-inter" ":" duration        -> server_agent_inter
                | "agent-send" ":" string           -> server_agent_send
                | "check-proto" ":" string          -> server_check_proto
                | "check-send-proxy" ":" boolean    -> server_check_send_proxy
                | template_spread                   -> server_template_spread

template_spread: "@" identifier

server_template_block: "server-template" identifier range_expr "{" server_property* "}"

range_expr: "[" number ".." number "]"

compression_block: "compression" "{" compression_property* "}"

?compression_property: "algo" ":" string              -> compression_algo
                     | "type" ":" string_array        -> compression_type

// ===== Listen Section =====
listen_section: "listen" identifier "{" listen_property* "}"

?listen_property: bind_directive
                | "mode" ":" mode_value                    -> listen_mode
                | "description" ":" string                 -> listen_description
                | "disabled" ":" boolean                   -> listen_disabled
                | "enabled" ":" boolean                    -> listen_enabled
                | "id" ":" number                          -> listen_id
                | "guid" ":" string                        -> listen_guid
                | "balance" ":" balance_algo               -> listen_balance
                | acl_definition
                | acl_block
                | "option" ":" string_or_array             -> listen_option
                | servers_block                            -> listen_servers
                | health_check_block                       -> listen_health_check
                | "timeout_client" ":" duration            -> listen_timeout_client
                | "timeout_server" ":" duration            -> listen_timeout_server
                | "timeout_connect" ":" duration           -> listen_timeout_connect
                | "maxconn" ":" number                     -> listen_maxconn
                | "load-server-state-from-file" ":" load_server_state_mode  -> listen_load_server_state_from
                | "server-state-file-name" ":" server_state_file_name_value  -> listen_server_state_file_name
                | "log-tag" ":" string                   -> listen_log_tag
                | "log-format" ":" string                -> listen_log_format
                | "error-log-format" ":" string          -> listen_error_log_format
                | "log-format-sd" ":" string             -> listen_log_format_sd
                | http_request_block                     -> listen_http_request
                | http_response_block                    -> listen_http_response
                | http_after_response_block              -> listen_http_after_response
                | http_error_block                         -> listen_http_error
                | email_alert_block                        -> listen_email_alert
                | declare_capture_directive                -> listen_declare_capture
                | force_persist_directive                  -> listen_force_persist
                | ignore_persist_directive                 -> listen_ignore_persist
                | "clitcpka-cnt" ":" number                -> listen_clitcpka_cnt
                | "clitcpka-idle" ":" duration             -> listen_clitcpka_idle
                | "clitcpka-intvl" ":" duration            -> listen_clitcpka_intvl
                | "srvtcpka-cnt" ":" number                -> listen_srvtcpka_cnt
                | "srvtcpka-idle" ":" duration             -> listen_srvtcpka_idle
                | "srvtcpka-intvl" ":" duration            -> listen_srvtcpka_intvl
                | "rate-limit" "sessions" ":" number       -> listen_rate_limit_sessions

// ===== Stats Socket =====
stats_socket_item: "stats_socket" string "{" stats_socket_param* "}"
                 | "stats_socket" string

?stats_socket_param: "level" ":" string      -> stats_socket_level
                   | "mode" ":" string       -> stats_socket_mode
                   | "user" ":" string       -> stats_socket_user
                   | "group" ":" string      -> stats_socket_group
                   | "process" ":" string    -> stats_socket_process

// ===== Peers Section =====
peers_section: "peers" identifier "{" peer_item* "}"

?peer_item: "peer" identifier string number  -> peer_definition
          | "disabled" ":" boolean           -> peers_disabled

// ===== Resolvers Section =====
resolvers_section: "resolvers" identifier "{" resolver_property* "}"

?resolver_property: "nameserver" identifier string number      -> nameserver_definition
                  | "accepted_payload_size" ":" number         -> resolvers_accepted_payload_size
                  | "hold_nx" ":" duration                     -> resolvers_hold_nx
                  | "hold_obsolete" ":" duration               -> resolvers_hold_obsolete
                  | "hold_other" ":" duration                  -> resolvers_hold_other
                  | "hold_refused" ":" duration                -> resolvers_hold_refused
                  | "hold_timeout" ":" duration                -> resolvers_hold_timeout
                  | "hold_valid" ":" duration                  -> resolvers_hold_valid
                  | "resolve_retries" ":" number               -> resolvers_resolve_retries
                  | "timeout_resolve" ":" duration             -> resolvers_timeout_resolve
                  | "timeout_retry" ":" duration               -> resolvers_timeout_retry

// ===== Mailers Section =====
mailers_section: "mailers" identifier "{" mailer_property* "}"

?mailer_property: "mailer" identifier string number   -> mailer_definition
                | "timeout_mail" ":" duration          -> mailers_timeout_mail

// ===== ACL Definition =====
// ACL block containing multiple ACLs
acl_block: "acl" "{" acl_item+ "}"

acl_item: identifier identifier (string | number)*

// Single ACL definition
acl_definition: "acl" identifier "{" acl_criterion "}"

acl_criterion: identifier (string | number)*

// ===== Template Definition =====
template_definition: "template" identifier "{" template_property+ "}"

template_property: identifier ":" value

// ===== Variable Declaration =====
variable_declaration: "let" identifier "=" expression

// ===== Import =====
import_statement: "import" string

// ===== Control Flow =====
if_statement: "if" expression "{" statement* "}" else_clause?

else_clause: "else" "{" statement* "}"
           | "else" if_statement

for_statement: "for" identifier "in" for_iterable "{" for_body "}"

for_iterable: range_expr
            | identifier
            | array

for_body: server_item*

// ===== Expressions =====
?expression: or_expr

?or_expr: and_expr ("||" and_expr)*

?and_expr: comparison_expr ("&&" comparison_expr)*

?comparison_expr: add_expr (comparison_op add_expr)*

comparison_op: "==" | "!=" | "<" | ">" | "<=" | ">="

?add_expr: mul_expr (add_op mul_expr)*

add_op: "+" | "-"

?mul_expr: unary_expr (mul_op unary_expr)*

mul_op: "*" | "/" | "%"

?unary_expr: unary_op unary_expr
           | postfix_expr

unary_op: "!" | "-"

?postfix_expr: primary_expr (postfix_op)*

?postfix_op: "." identifier
           | "[" expression "]"

?primary_expr: identifier
             | number
             | string
             | boolean
             | "(" expression ")"
             | env_call

env_call: "env" "(" string ("," simple_value)? ")"

// ===== Values =====
?value: simple_value
      | array
      | object

?simple_value: string
             | duration  // Must come before number to match duration first
             | number
             | boolean
             | identifier

?string_or_array: string
                | string_array

string_array: "[" [string_list] "]"
string_list: string ("," string)*

identifier_array: "[" [identifier_list] "]"
identifier_list: identifier ("," identifier)*

array: "[" [value_list] "]"
value_list: value ("," value)*

object: "{" [object_pair_list] "}"
object_pair_list: object_pair ("," object_pair)*
object_pair: (identifier | string) ":" value

// ===== Primitives =====
// Terminals defined with priority hints
// Use word boundaries to prevent matching TIME_UNIT as part of identifiers
TIME_UNIT.2: /(?:ms|[smhd])\b/
BOOLEAN.2: "true" | "false" | "yes" | "no" | "on" | "off" | "1" | "0"
INT: /\d+/
FLOAT: /\d+\.\d+/
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/

identifier: IDENTIFIER

string: ESCAPED_STRING | INTERPOLATED_STRING | VAR_REF

INTERPOLATED_STRING: /"[^"]*\$\{[^}]+\}[^"]*"/  // String with ${var}

VAR_REF: /\$\{[a-zA-Z_][a-zA-Z0-9_]*\}/  // Bare ${var} reference

number: INT | FLOAT

?number_or_string: number | string

boolean: BOOLEAN

// ===== Comments and Whitespace =====
%import common.ESCAPED_STRING
%import common.WS
%import common.CPP_COMMENT    // C++ style comments //
%import common.C_COMMENT      // C style comments /* */

%ignore WS
%ignore CPP_COMMENT
%ignore C_COMMENT
